version: "3"

tasks:
  lock:
    desc: "lock with update"
    cmds:
      - uv lock --upgrade

  install:
    desc: "install local dependencies"
    cmds:
      - uv sync --all-extras --frozen

  lint:
    desc: "run linters"
    cmds:
      - uv run ruff format .
      - uv run ruff check . --fix
      - uv run mypy .

  lint-ci:
    desc: "run linters"
    cmds:
      - uv run ruff format . --check
      - uv run ruff check . --no-fix
      - uv run mypy .

  tests:
    desc: "run pytest (pass args after '--')"
    cmds:
      - uv run pytest {{.CLI_ARGS}}

  release:
    desc: "bump version, create tag and release, publish to PYPI"
    cmds:
      - git checkout main
      - git pull
      - rm -rf ./dist
      - git add pyproject.toml
      - git commit -m "bump version to {{.CLI_ARGS}}"
      - uvx --from build pyproject-build --installer uv
      - twine upload dist/*
      - git tag {{.CLI_ARGS}}
      - git push
      - git push --tags
      - gh release create --generate-notes {{.CLI_ARGS}}
      - gh release upload {{.CLI_ARGS}} ./dist/*

  publish:
    cmds:
      - rm -rf dist/*
      - uvx --from build pyproject-build --installer uv
      - uv tool run twine check dist/*
      - uv tool run twine upload dist/* --username __token__ --password $PYPI_TOKEN
